.. _mep_system:

3. Prepare the membrane-embedded protein (MEP) system.
=======================================================

3.1. Creating the MEP system using CHARMM-GUI.
-----------------------------------------------

Prepare the membrane-embedded protein system using `CHARMM-GUI <https://www.charmm-gui.org/>`_, making sure that the protein is correctly placed in the membrane. Use only POPC for the membrane for a simple yet effective membrane. While the lipid is characterized in AMBER, it should be no problem to use a more complex membrane (i.e., add cholesterol).

Remember to align the protein to the Z axis and use the AMBER FF. The membrane must be parametrized with AMBER for a better reliability with GAFF2, with which the small molecules are parametrized.

.. note::

    The protein must be embedded in the membrane at the correct depth to avoid spending simulation time on achieving it.
    You can use ``nemat cm`` to obtain a Python file to color the B-factor of your protein based on whether the residue is
    inside (I) or outside (O) of the membrane or at the membrane itself (M). 

    1. Provide the FASTA of your protein to the `DeepTMHMM-1.0 <https://services.healthtech.dtu.dk/services/DeepTMHMM-1.0/>` server.
    2. Copy the MOI sequence (i.e. IIIOMMMMMMOOOIIIIIII...) on the corresponding variable of ``membrane_bfactor.py``
    3. Change the names of the input and output for your protein.
    4. Run the program with ``python membrane_bfactor.py`` and open the new protein with VMD.
    5. Download ``step3_packing.pdb`` from the 3rd step of CHARMM-GUI and open it with VMD.
    6. Use the *Extensions > Analysis > RMSD calculator*, uncheck the backbone only option, and write ``name CA and segname PROA A`` (A is the name of the chain of the original protein). Then, click "Align".
    7. Use *Display > Orthographic* and *Extensions > Visualization > Ruler* to have an idea of which is the shift in Amstrongs of the proposed membrane. If the white region does not match the proposed membrane, you will have to move the protein in step 2 of CHARMM-GUI.


Use only the *gromacs* folder of the output generated by CHARMM-GUI. Rename the following files provided by CHARMM-GUI:

1. ``step5_input.gro`` --> ``system.gro``
2. ``topol.top`` --> ``system.top``

The proteins folder should contain at least the following files per protein (prot1, prot2, etc):

.. code-block:: text

    proteins
      |  |
      |  |-- prot1
      |  |    |
      |  |    |-- toppar
      |  |    |-- system.gro
      |  |    |-- system.top
      |  |
      |  |-- prot2
      |  |    |
      |  |    |-- toppar
      |  |    |-- system.gro
      |  |    |-- system.top
      |  |
      |  |-- ...


3.2. Using a different method.
--------------------------------

NEMAT searches for the files ``system.top`` (which references files inside the ``toppar`` folder), ``system.gro``, and the folder ``toppar``. Therefore, any set of files following this structure is a valid input for NEMAT. 

.. note::

   Actually, you could just change a force field folderâ€™s name to ``toppar`` 
   and update the ``#include`` inside the topology file. This would still 
   provide a valid input for NEMAT.

If you are using a custom force field, it is recommended to use the same for the membrane system. 



