# NEMAT
Non-Equilibrium Membrane Alchemical Transformations

## Step by step guide

### 1. CHARMM-GUI

#### 1.1. Protein + membrane AA system

Prepare the Protein + membrane AA system using CHARMM-GUI making sure that the protein is correctly placed in the membrane. Use only POPC for the membrane for a simple yet effective membrane. While the lipid is characterized in AMBER, it should be no problem to use a more complex membrane.

Remember to align the protein to the Z axis and use the AMBER FF. The membrane must be parametrized with AMBER for a better reliability with GAFF with which the small molecules are parametrized.

Use only the *gromacs* folder of the output generated by CHARMM-GUI. Create the folder *proteins* and add the new protein inside. Rename every folder as the protein and the following files provided by CHARMM-GUI.   

1. *step5_input.gro*   -->   `system.gro`
2. *topol.top*              -->   `system.top`  

The *proteins* folder should contain at least the following:

		proteins
		  |  |
		  |  |-- prot1
		  |  |    |
		  |  |	  |-- toppar
		  |  | 	  |-- system.gro
		  |  |	  |-- system.top
		  |  |	 	
		  |  |-- prot2
		  |  |    |
		  |  |	  |-- toppar
		  |  | 	  |-- system.gro
		  |  |	  |-- system.top
		  |  |	 	
		  |  |-- ...

If, for any case, a different input generator other than CHARMM-GUI is used, then the easiest way to add the force field is to create a folder named *toppar* emulating the one generated by CHARMM-GUI and adding there the *itps* for water, forcefield, protein...  
#### 1.2. Membrane system 

Prepare a bilayer membrane system which is consistent with the protein + membrane system. This means using the same kind of water (TP3, OPC...), teh same AMBER FF and the same lipids that are on the membrane (usually only POPC). 

The XY size of the box can be of approximately 4 nm (40 Amstrongs) which means 24 POPCs per layer. For very large ligands (or peptides) this must be increased which will only have an effect on the running time.  

Take the *gromacs* folder and place it on your workspace. Rename it as `membrane`. Even though the program will only care about the *gro* file, you can have the *mdp* files in `mdppath` replaced and adapted (if the membrane is not solely POPC) by the ones generated by CHARMM-GUI after a proper readjustment.

> [!NOTE]
> If you are using your own *mdp* files, don't forget to add the free energy inputs:
> ```mdp
> ; Free energy control stuff
> free-energy = yes
> init-lambda = 0 ; 0 for state A and 1 for state B
> delta-lambda = 0
> sc-alpha = 0.3
> sc-sigma = 0.25
> sc-power = 1
> sc-coul = yes
> ```

If you want to use default values, change the *step5_input.gro* file name for *membrane.gro* and the *topol.top* for *membrane.top*. 

If, for any case, a different input generator other than CHARMM-GUI is used, then the easiest way to add the force field is to create a folder named *toppar* emulating the one generated by CHARMM-GUI and adding there the *itps* for water, forcefield, POPC... 

The *membrane* folder should contain at least the following:

		membrane
		  |  |
		  |  |-- toppar
		  |  |-- membrane.gro
		  |  |-- membrane.top

#### 1.3. About the *mdp* files

There are some things that may be difficult to track about the *mdp* files. One of them is the `tc-grps` and how are they defined. For the protein we have:

```bash
tc_grps = SOLU MEMB SOLV
```

Where SOLV (for solvent) includes the water and the ions, MEMB is the membrane and SOLU (for solute) is the protein and the ligand. On the `_prepare_prot_tpr()` function, an index is generated and used in the `grompp` automatically. If you are having problems look there :).

Again, the program assumes that the input files were generated using CHARMM-GUI. For the membrane we have:

```bash
tc_grps = MEMB SOLV LIG
```

Which is as stated before but now the ligand, since it's the only solute, it is named LIG.

The default *mdp* files are stored on the *mdppath* folder. This folder contains:
	
1. Minimization files for the protein, the ligand and the membrane systems. These are named as "prot_em_l0.mdp"
2. Equilibration files for  the protein (6), the ligand (1) and the membrane (6) systems. These are named as "prot_eq(n)\_l0.mdp" where $n \in [1,6]$.
3. Production files for the protein, the ligand and the membrane systems. Are
 
 ### 2. Align the protein + ligand 

Use the *pdb* containing the protein and the ligand and align them with the new generated system. 

Then extract the ligand which will serve as a reference for aligning the other ligands. Save it as *ref_lig.pdb*.

### 3. Ligand preparation

Add hydrogens to the reference ligand and to the rest (for example using CHARMM-GUI). Remember that *lovoalign* needs at least 15 atoms to align 2 molecules which it is usually reached if hydrogens are added. 

Use the program `align.sh` to prepare the ligands and generate `ligands.sdf` and all the necessary files. In this case, it will align the ligands with the reference ligand and then generate *mol2* files for every ligand. You can use the *ligands.sdf* file to both visualize all the ligands at once and, for example, to use some program such as [openFE](https://colab.research.google.com/github/OpenFreeEnergy/ExampleNotebooks/blob/main/openmm_rbfe/OpenFE_showcase_1_RBFE_of_T4lysozyme.ipynb) to generate a mapping of the ligands and determinate the possible edges.

The *ligands* fodler should contain the *mol2* of all the ligands. If you have the ligands as *pdb* or *sdf*, you can use `align.sh` to have them all aligned and transformed to the correct format 

		ligands
		  |  |
		  |  |-- lig1.mol2
		  |  |-- lig2.mol2
		  |  |-- lig3.mol2

### 4. The protein folder

Change the values that need to be change in the main function of `prepare_inputs_md.py` and run it to generate the folder containing all the initial files. This will generate a folder containing the following folders:
* **proteins**  :  contains several folders named as the proteins that will be used (usually one).
* **ligands**    : contains several folders named as the ligands of the different edges. For every ligand a topology and grometry is generated using the GAFF.
* **mdppath** : contains all the `mdp` files for the simulations. They, of course, can be modified to adjust to your simulation. the default values correspond to:
	* An *equilibration* of 0.5 ns for the ligand and 0.6 ns for the protein (which takes 6 steps since the membrane is not defined as flexible since the beginning). 
	* A *production* of 50 ns. You can make it longer however, for what we have tested, it makes no difference. 
	* *Transitions* of 200 ps.
* **membrane**


> [!NOTE]
> It is important that you generate the protein topology using CHARMM-GUI and the AMBER force field since the `mdp` files assume that this was the procedure for obtaining the protein structure. If it was not your case, adapt your _mpd_ files to work with the system. If you are using your own *mdp* files, don't forget to add the free energy inputs:
> ```mdp
> ; Free energy control stuff
> free-energy = yes
> init-lambda = 0 ; 0 for state A and 1 for state B
> delta-lambda = 0
> sc-alpha = 0.3
> sc-sigma = 0.25
> sc-power = 1
> sc-coul = yes
> ```

Every protein in the `proteins` folder will contain the following files:

1. The *gro* file of the protein: `system.gro`
2. The *toppar* folder. It should contain `itp` files for the ions (i.e. CL.itp), the protein (PROA.itp), the solute (TP3.itp), the membrane (POPC.itp) and finally the forcefield (forcefield.itp).
3. The *top*  file  `system.top`


### 5. System assembly

We will start with a ligand + water system (normal) against a ligand + protein + membrane system. 

Use the `file_gestor.py` program to generate the starting system:

```bash
python file_gestor.py
```

This will do the following for the different cases:
#### 5.1 Ligand + water

Here we will follow the same path that the normal *AZtutorials* follows. Create the hybrid ligand and add water, ions....

#### 5.2 Protein + ligand + membrane

Since the CHARMM-GUI output contains a `gro` file with water, ions and membrane, we "only" need tot add the hybrid ligand inside the protein and skip all the steps that the single ligand needs (box, salvation and ionization).

#### 5.3 Membrane + ligand 

To assemble the system membrane + ligand, the hybrid ligand *gro* file is taken and then used to create the whole system. Since the membrane is generated with CHARMM-GUI, we will place the ligand at the center of the box. This may create overlap between the ligand and some POPC molecules. In this case, you can consider both removing some POPC molecules or increasiung the minimization time of the system.

This is specially true when the small molecule is large.

### 6. Minimization

The only case in which needs special care is the membrane + large ligand system. Here the minimization could crash or may need more steps.



