# NEMAT

Non-Equilibrium Membrane Alchemical Transformations


# 1. Requirements

To obtain the code, use:

```bash
git clone https://github.com/QTC-IQAC/NEMAT.git
```

Once the code is downloaded, go to the NEMAT folder and create the environment using:

```bash
conda env create -f environment.yml -n NEMAT
```

This will take some minutes, be patient! On the other hand, having *[lovoalign](https://m3g.github.io/lovoalign/)* is recomended. If not, small molecules can be aligned manually or with any other software.

# 2. Input preparation

## 2.1 CHARMM-GUI

Create the folder *proteins* (or open it if already exists) and create a subfolder for every protein. Then process the protein using CHARMM-GUI. It is improtant that the protein used in CHARMM-GUI is the same that you will use as a reference (*prot_lig.pdb*).

You also need to create a membrane using the same procedure (section 1.2). A standard POPC membrane is provided and can be used. The size of the membrane is 4 nm (XY) and the ions used are Na+ Cl-. If you use this membrane, you can skip section 1.2.
#### 2.1.1. Protein + membrane system

Prepare the Protein + membrane AA system using CHARMM-GUI making sure that the protein is correctly placed in the membrane. Use only POPC for the membrane for a simple yet effective membrane. While the lipid is characterized in AMBER, it should be no problem to use a more complex membrane.

Remember to align the protein to the Z axis and use the AMBER FF. The membrane must be parametrized with AMBER for a better reliability with GAFF with which the small molecules are parametrized.

Use only the *gromacs* folder of the output generated by CHARMM-GUI. Create the folder *proteins* and add the new protein inside. Rename every folder as the protein and the following files provided by CHARMM-GUI.   

1. *step5_input.gro*   -->   `system.gro`
2. *topol.top*              -->   `system.top`  

The *proteins* folder should contain at least the following:

		proteins
		  |  |
		  |  |-- prot1
		  |  |    |
		  |  |	  |-- toppar
		  |  | 	  |-- system.gro
		  |  |	  |-- system.top
		  |  |	 	
		  |  |-- prot2
		  |  |    |
		  |  |	  |-- toppar
		  |  | 	  |-- system.gro
		  |  |	  |-- system.top
		  |  |	 	
		  |  |-- ...

If, for any case, a different input generator other than CHARMM-GUI is used, then the easiest way to add the force field is to create a folder named *toppar* emulating the one generated by CHARMM-GUI and adding there the *itps* for water, forcefield, protein...  
#### 2.1.2. Membrane system 

Prepare a bilayer membrane system which is consistent with the protein + membrane system. This means using the same kind of water (TP3, OPC...), the same AMBER FF and the same lipids that are on the membrane (usually only POPC). 

The XY size of the box can be of approximately 4 nm (40 Amstrongs) which means 24 POPCs per layer. For very large ligands (or peptides) this must be increased which will only have an effect on the running time.  

Take the *gromacs* folder and place it on your workspace. Rename it as `membrane`. Even though the program will only care about the *gro* file, you can have the *mdp* files in `mdppath` replaced and adapted (if the membrane is not solely POPC) by the ones generated by CHARMM-GUI after a proper readjustment.

> [!NOTE]
> If you are using your own *mdp* files, don't forget to add the free energy inputs to all the *mdp* files. At least the `init-lambda` parameter is needed to indicate if the ligand is in the state A or B. At the transitions, the other parameters become relevant:
> 
> ```mdp
> ; Free energy control stuff
> free-energy = yes
> init-lambda = 0 ; 0 for state A and 1 for state B
> delta-lambda = 0
> sc-alpha = 0.3
> sc-sigma = 0.25
> sc-power = 1
> sc-coul = yes
> ```

If you want to use default values, change the *step5_input.gro* file name for *membrane.gro* and the *topol.top* for *membrane.top*. 

If, for any case, a different input generator other than CHARMM-GUI is used, then the easiest way to add the force field is to create a folder named *toppar* emulating the one generated by CHARMM-GUI and adding there the *itps* for water, forcefield, POPC... 

The *membrane* folder should contain at least the following:

		membrane
		  |  |
		  |  |-- toppar
		  |  |-- membrane.gro
		  |  |-- membrane.top

#### 2.1.3. About the *mdp* files

There are some things that may be difficult to track about the *mdp* files. One of them is the `tc-grps` and how are they defined. For the protein we have:

```bash
tc_grps = SOLU MEMB SOLV
```

Where SOLV (for solvent) includes the water and the ions, MEMB is the membrane and SOLU (for solute) is the protein and the ligand. On the `_prepare_prot_tpr()` function, an index is generated and used in the `grompp` automatically. If you are having problems look there :).

Again, the program assumes that the input files were generated using CHARMM-GUI. For the membrane we have:

```bash
tc_grps = MEMB SOLV LIG
```

Which is as stated before but now the ligand, since it's the only solute, it is named LIG.

The default *mdp* files are stored on the *mdppath* folder. This folder contains:
	
1. Minimization files for the protein, the ligand and the membrane systems. These are named as "prot_em_l0.mdp"
2. Equilibration files for  the protein (6), the ligand (1) and the membrane (6) systems. These are named as "prot_eq(n)\_l0.mdp" where $n \in [1,6]$.
3. Production files for the protein, the ligand and the membrane systems. Are named as "prot_md_l0.mdp" 
4. Finally, the transitions files are named as "prot_ti_l0.mdp".

If you want to change an *mdp* file, we strongly recommend to add only the free energy parameters that are in the original *mdp* file to avoid undesired errors.



### 2.2 Ligand preparation 

First of all we need to align the original protein+ ligand system tot the newly generated GROMACS system. Use VMD or any aligning tool to align the two proteins. For VMD you could do:

1. Load the two proteins. In this case: `system.gro` and `prot_lig.pdb`. 
2. Go to `Extensions > Analysis > RMSD calculator`.  This will display a new window.
3. At the top left box, type `name CA` .
4. Unclick the option *Backbone only*.
5. Click *Align* to align the two systems.
6. Save the new ligand coordinates.

> [!WARNING]
> It is important that the GROMACS system (`system.gro`) is marked with the option *"T"* on the VMD main page. If not, the whole system will be aligned to the protein and not the other way around.

Then extract the ligand which will serve as a reference for aligning the other ligands. Save it as *ref_lig.pdb*.

Add hydrogens to the reference ligand and to the rest (for example using CHARMM-GUI). Remember that *lovoalign* needs at least 15 atoms to align 2 molecules which it is usually reached if hydrogens are added. 

Use the program `align.sh` to prepare the ligands and generate `ligands.sdf` and all the necessary files. In this case, it will align the ligands with the reference ligand and then generate *mol2* files for every ligand. You can use the *ligands.sdf* file to both visualize all the ligands at once and, for example, to use some program such as [openFE](https://colab.research.google.com/github/OpenFreeEnergy/ExampleNotebooks/blob/main/openmm_rbfe/OpenFE_showcase_1_RBFE_of_T4lysozyme.ipynb) to generate a mapping of the ligands and determinate the possible edges.

The *ligands* folder should contain the *mol2* of all the ligands. If you have the ligands as *pdb* or *sdf*, you can use `align.sh` to have them all aligned and transformed to the correct format: 

		ligands
		  |  |
		  |  |-- lig1.mol2
		  |  |-- lig2.mol2
		  |  |-- lig3.mol2
		  |  |-- ...


> [!NOTE]
> Check that the ligand alignment is correct. If the molecule is small, it is possible that something went wrong.
> 
> You can manually align the ligands and directly save the *mol2* files at the *ligands* folder.



## 2.3 Input

An example of an input for the FEP simulation can be found in `input.yaml`:

```yaml
  

##############################
#       PREPARE INPUTS       #
##############################

inputDirName: 'OR31_input' # path to the directory where the input files will be located.
proteinName: 'S31' # name of the protein in inputDirName/proteins that will be used.

##############################
#      SIMULATION INPUT      #
##############################

workPath: 'workpath_BAE_PAE' # path to the directory where the simulations will run
replicas: 3 # set the number of replicas (several repetitions of calculation are useful to obtain reliable statistics)
edges: # List of lists containing the edges.
- ['Benzaldehyde','2-phenylacetaldehyde']
# - ['Acetophenone', 'Benzyl_Alcohol']
# - ['Acetophenone', 'Benzaldehyde']
# - ['2-phenylacetaldehyde', 'Benzyl_Alcohol']

pname: 'NA' # Which positive ions to use in the ligand simulations
nname: 'CL' # Which negative ions to use in the ligand simulations
slotsToUse: 6 # Use if you want to limit the number of jobs running at the same time in the cluster.
frameNum: 200 # Number of frames to extract to make transitions. The default production will generate 400 frames so this is the default upper limit

##############################
#    JOB SUBMISSION INPUTS   #
##############################

JOBsimcpu: 24 # Number of CPUs to use for the simulation jobs
JOBmodules: # List of modules to load for the simulation jobs
- 'gromacs-plumed/2024.2-2.9.2'

JOBgmx: 'gmx mdrun -maxh 72' # Command to run the simulation jobs
JOBpartition: 'gpu' # Partition to use for the simulation jobs
JOBsimtime: '3-00:00' # Time limit for the simulation jobs
JOBmpi: False # Set to True if you want to specifically display -ntmpi 1
```

Remember to load GROMACS using `JOBmodules` if it's a module or manually. More modules can be loaded but only GROMACS is strictly necessary. 

On the other hand it is important that the GROMACS executable `gmx` exists. If you only have `gmx_mpi` as an executable, the program will fail.

Other options for the input file are:

----> LIST OF OPTIONS <----


# 3. Running NEMAT

It is recommended to use the Makefile to run the NEMAT code (to avoid errors). 

> [! NOTE]
> You can always use `make check_{step}` to display the warnings and errors that occured during the preparation of an specific step (*prep*, *min*, *eq*, *md* or *ti*). 
> 
> This will display the warnings and errors produced by GROMACS. Each warning and error is titled as error\_{line} or warning\_{line} where *line* is the line of the original file where the error occured.
> 

Use `make help` to display all the options.



## 3.1 System Assembly

First of all it is convenient to generate the structure of the simulation results and also process the ligand with *acpype* (creates hybrids of the ligands). In order to do this, we will use the `prepare_input_md.py` program. This program can be executed using (recommended):

```bash
make prep
```

Or step by step by running (recommended only when debugging):

```bash
python NEMAT/prepare_input_md.py
```

Check the new input folder that was created. It must contain:

1. A folder named *lignads* containing all the ligands involved in the edges.
2. A folder named *proteins* containing the protein files.
3. A folder named *membrane* containing the membrane files.
4. A folder named *mdppath* containing the *mpd* files for the simulations.

Now we can start assembling the system. Use the `file_gestor.py` program to assemble the starting system:

```bash
python NEMAT/file_gestor.py --step prep
```



## 3.2 Minimization

The only case in which needs special care is the membrane + large ligand system. Here the minimization could crash or may need more steps.

You can prepare the minimization files by using:

```bash
make prep_min
```

This will generate all the job scripts for the SLURM cluster. Then go to your workspace, and you will find a folder named `em_jobscripts` which contains all the files to run the minimization. Then, while inside the `em_jobscripts` folder, use:

```bash
sbatch submit_scripts.sh
```

To submit the job array. 


## 3.3 Equilibration

You can prepare the equilibration files by using:

```bash
make prep_eq
```

This will generate all the job scripts for the SLURM cluster. Then go to your workspace, and you will find a folder named `eq_jobscripts` which contains all the files to run the minimization. Then, while inside the `eq_jobscripts` folder, use:

```bash
sbatch submit_scripts.sh
```


## 3.4 Production

You can prepare the production files by using:

```bash
make prep_md
```

This will generate all the job scripts for the SLURM cluster. Then go to your workspace, and you will find a folder named `md_jobscripts` which contains all the files to run the minimization. Then, while inside the `md_jobscripts` folder, use:

```bash
sbatch submit_scripts.sh
```


## 3.5 Transitions

You can prepare the production files by using:

```bash
make prep_ti
```

This will generate all the job scripts for the SLURM cluster. Then go to your workspace, and you will find a folder named `ti_jobscripts` which contains all the files to run the minimization. Then, while inside the `ti_jobscripts` folder, use:

```bash
sbatch submit_scripts.sh
```


# 4. Analysis

BLABLABLA FIGFIG FIG


# 5. Possible errors 

### 1. Energy minimization has stopped

> [! error]
> Energy minimization has stopped, but the forces have not converged to the
requested precision Fmax < 1000 (which may not be possible for your system).
It stopped because the algorithm tried to make a new step whose size was too
small, or there was no change in the energy since last step. Either way, we
regard the minimization as converged to within the available machine
precision, given your starting configuration and EM parameters.

This is not necessarily an error and it will depend on the final values of specially the maximum force:

```bash
Potential Energy  =  4.8533396e+09
Maximum force     =  1.2402948e+12 on atom 8201
Norm of force     =  3.6336824e+09
```

If values are larger than $10^3$, something wrong has occurred. A possible solution is to enlarge a little bit the PBC box (for example 0.2 per side is enough but you can enlarge it more). 

This will occur usually if the protein is large and, therefore, the membrane must be too in order to avoid rings with the protein. 
